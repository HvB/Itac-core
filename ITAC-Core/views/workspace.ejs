<html>
  <head>
    <title><%= title %></title>

	<% include entete %>.

 	<link rel="stylesheet"  href="/stylesheets/styleClientCollab.css" />

 	<script type="text/javascript">
 		var urldemande = '<%= urldemande %>';
 		var zpdemande = '<%= myZP %>';
 		var rang= '<%= rangZP %>';

 		// on declare l'objet myZC qui va  etre la zone collaborative
 		var myZC = {};
 		var ZEmax= '<%= NbZEMax %>';
 		
 		// tableau qui va permettre de positionner correctement les zones d'�change (position, taille, orientation)
 		var paramAffichageZE = [];
 		var orientationZE = [];
 		
 		// declarion de la variable socket
 		var socket = null; 

		console.log('******************* PARAMETRE PASSE PAR LA REQUETE  ********************************');
		console.log('PAGE ZA : workspace.ejs -> urldemande = '+urldemande);
		console.log('PAGE ZA : workspace.ejs -> zpdemande = '+zpdemande);
		console.log('PAGE ZA : workspace.ejs -> rang = '+rang);
		console.log('PAGE ZA : workspace.ejs -> ZEmax = '+ZEmax);
		console.log('****************************************************************************');
		console.log('');

 	</script>
 	
    <script language="JavaScript" type="text/javascript" src="/socket.io-client/socket.io.js"></script>
    
    <script>
    
		/* ------------------------------------------------*/
		/*  connexion soket 								 */
		/* ------------------------------------------------*/
		
		console.log('****************************************************************************');
		console.log('PAGE ZA : workspace.ejs -> **** demande connexion socket sur : '+ urldemande);	
		socket = io.connect(urldemande, {transports:['websocket']});
		console.log('PAGE ZA : workspace.ejs -> **** connexion socket [OK] : idSocket ='+socket.id);
		console.log('****************************************************************************');
    </script>
    
    <script language="JavaScript" type="text/javascript" src="/javascripts/interact.js"></script>
    
    <script language="JavaScript" type="text/javascript" src="/javascripts/menuITAC.js"></script>
    <script language="JavaScript" type="text/javascript" src="/javascripts/interactITAC.js"></script>
    <script language="JavaScript" type="text/javascript" src="/javascripts/artefactsITAC.js"></script>
		
  </head>

  <!-- le corps est la ZP et ne contient que le menu -->
  <body id="ZP">
  
 	 <div id="menu" class="menu hand"></div>
 	 
  </body > 
  

  
  <script type="text/javascript">

		// Attente fin de chargement
		if(jQuery.ui){
			//alert(" jQuery.ui loaded")
		}
		else {
			alert(" jQuery.ui non chargee")
		}
   
   		/* ------------------------------------------------*/
		/* --- premiere connexion ZA (Zone d'Activit� = Serveur ?)---*/
		/* ------------------------------------------------*/
    	
    	socket.emit('EVT_DemandeConnexionZA', urldemande, zpdemande);
    	console.log('PAGE : workspace.ejs -> emission evenement EVT_DemandeConnexionZA pour ZP= '+zpdemande);
    			
		socket.on('EVT_ReponseOKConnexionZA',function(ZC) {
	  	
			// on r�cup�re tout le param�trage de la Zone Collaborative

			myZC = ZC;
			
			console.log('PAGE : workspace.ejs -> ZC ='+JSON.stringify(myZC));					
			console.log('PAGE : workspace.ejs -> menu ITAC initiale : '+ menuITAC );			
			console.log('PAGE : workspace.ejs -> ajout des ZP , total ='+ myZC.nbZP) ;
			
			for(var i=0; i<myZC.nbZP; i++) { 
				if (i != rang) {
					console.log('PAGE : workspace.ejs -> menu ITAC , push = '+myZC.ZP[i].idZP+" ZP" );
					menuITAC.push("ZP" );
					//classmenuITAC.push("menu ZP"+i);
					contenuMenu.push(myZC.ZP[i].idZP);
				}				
			}
			console.log('PAGE : workspace.ejs -> menu ITAC en cours : '+ menuITAC);

			
    		alert('Zone collaborative active : '+ myZC.idZC+'\n\nBienvenue sur l\'Espace de Partage :'+myZC.ZP[rang].idZP+'\n\n');
    		console.log('PAGE : workspace.ejs -> reception evenement [EVT_ReponseOKConnexionZA] pour ZP= '+myZC.ZP[rang].idZP);
    		
    		// l�-dessous on a typeZP qui n'apparait pas
    		console.log('PAGE : workspace.ejs -> parametre de ZP = '+JSON.stringify(myZC.ZP[rang]));
    	
    		// on lance le calcul des param�tres d'affichage
    		Calcule_Nb_ZE('Table1',ZEmax);
    		console.log('PAGE : workspace.ejs -> calcul taille ZE , largeur max = '+paramZAITAC['Table1'][0]+' hauteur Max = '+paramZAITAC['Table1'][1]);
    		console.log('PAGE : workspace.ejs -> calcul taille ZE , NB_ZE_Largeur = '+NB_ZE_Largeur+' NB_ZE_Hauteur = '+NB_ZE_Hauteur);
    		console.log('PAGE : workspace.ejs -> calcul taille ZE , TailleZEenlargeur = '+TailleZEenlargeur+ ' TailleZEenhauteur = '+TailleZEenhauteur);
    		console.log('PAGE : workspace.ejs -> calcul taille ZE , TailleEspaceenlargeur = '+TailleEspaceenlargeur+ ' TailleEspaceenhauteur = '+TailleEspaceenhauteur);
    		
    		// on cree les DIV pour les ER  [TC]  Les ZE non???
    		$( document ).ready(function() {
				for(var i=1; i<=ZEmax; i++) 
				{
				    var codeZE='ZE'+i;
 					paramAffichageZE[codeZE] = new Array(0,0,0,0,0);
 					orientationZE[codeZE]= new Array('');
 					
 					if (i <= NB_ZE_Largeur) {
	 					paramAffichageZE[codeZE][0]=TailleZEenlargeur;             // largeur
	 					paramAffichageZE[codeZE][1]=paramZAITAC['Table1'][5];				               // hauteur
	 					paramAffichageZE[codeZE][2]=180;				           // rotation
	 					paramAffichageZE[codeZE][3]=0;				 			   // pos X - top
	 					paramAffichageZE[codeZE][4]=paramZAITAC['Table1'][5]+TailleEspaceenlargeur*i+TailleZEenlargeur*(i-1);       // pos Y -left
	 					orientationZE[codeZE]='top';
 					}
 					else if (i <= NB_ZE_Largeur+NB_ZE_Hauteur) {
 						paramAffichageZE[codeZE][0]=paramZAITAC['Table1'][5];
	 					paramAffichageZE[codeZE][1]=TailleZEenhauteur;
	 					paramAffichageZE[codeZE][2]=270;
	 					paramAffichageZE[codeZE][3]= TailleEspaceenhauteur*(i-NB_ZE_Largeur)+TailleZEenhauteur*(i-NB_ZE_Largeur-1);
	 					paramAffichageZE[codeZE][4]= paramZAITAC['Table1'][0]-paramZAITAC['Table1'][5]-0;
	 					orientationZE[codeZE]='right';
 					}
 					else if (i <= 2* NB_ZE_Largeur+NB_ZE_Hauteur) {
 						paramAffichageZE[codeZE][0]=TailleZEenlargeur;
	 					paramAffichageZE[codeZE][1]=paramZAITAC['Table1'][5];
	 					paramAffichageZE[codeZE][2]=0;
	 					paramAffichageZE[codeZE][3]=paramZAITAC['Table1'][1]-paramZAITAC['Table1'][5];
	 					paramAffichageZE[codeZE][4]=paramZAITAC['Table1'][5]+TailleEspaceenlargeur*(i-NB_ZE_Largeur-NB_ZE_Hauteur)+TailleZEenlargeur*(i-NB_ZE_Largeur-NB_ZE_Hauteur-1); 
	 					orientationZE[codeZE]='down';
 					}
 					else  {
 						paramAffichageZE[codeZE][0]=paramZAITAC['Table1'][5];
	 					paramAffichageZE[codeZE][1]=TailleZEenhauteur;
	 					paramAffichageZE[codeZE][2]=90;
	 					paramAffichageZE[codeZE][3]=TailleEspaceenhauteur*(i-2* NB_ZE_Largeur-NB_ZE_Hauteur)+TailleZEenhauteur*(i-2* NB_ZE_Largeur-NB_ZE_Hauteur-1);
	 					paramAffichageZE[codeZE][4]=0;
	 					orientationZE[codeZE]='left';
 					}
 					$("<div  id="+codeZE+"  class='zoneEchange' style ='position:absolute ; top: "+paramAffichageZE[codeZE][3]+" ; left: "+paramAffichageZE[codeZE][4]+" ; width:"+paramAffichageZE[codeZE][0] +" ; height :"+paramAffichageZE[codeZE][1] +"'  > </div>").appendTo("#ZP");
				}
			});
    		console.log('PAGE : workspace.ejs -> creation de div ZE nb='+ZEmax);
    		
    		
    		
    		
   		 });
   
		socket.on('EVT_ReponseNOKConnexionZA',function(ZC) {
    		myZC = ZC;
    		alert('Zone collaborative active : '+ myZC.idZC+'\n\nImpossible d\'acceder a l\'Espace de Partage :'+myZC.ZP[rang].idZP+'\n\n');
    		console.log('PAGE : workspace.ejs -> reception evenement [EVT_ReponseNOKConnexionZA] pour ZP= '+myZC.ZP[rang].idZP);
    	});
    	
    	/* ----------------------------- */
    	/* ----- connection d'une ZE ----*/
    	/* ----------------------------- */


	    socket.on('EVT_NewZEinZP', function(pseudo, idZE ,idZEP, posAvatar)
  			{
	    	console.log('PAGE : workspace.ejs -> Creation d une ZE ='+idZE+' \n ZEP associee = '+idZEP+'\n pour pseudo='+pseudo);
    		
    		$(function () {
        		
        		$("#"+idZE+"").slideDown(1000);

        	// $("<div  id="+idZE+"  class='zoneEchange' > <img id =avatar"+idZE+" ></img> </div>").appendTo("#ZP"); //Creation de la zone

			//$("#"+idZE+"").draggable({ drag: function (event, ui) {if($(this).find('div.artefact').length !=0){$this.draggable('option', 'disabled', true)}}  })
			//$("#"+idZE+"").click(function() { $(this).toggleClass('rotated')})
			/*
				$("#"+idZE+"").click(function() {
				var angle = ($(this).data('angle')+90)||90;
				$(this).css({'transform': 'rotate('+ angle +'deg)'});
				$(this).data('angle', angle);

			})*/
        	/*interact("#"+idZE+"")
       	 
        	  .resizable({
        	    preserveAspectRatio: false,
        	    edges: { left: true, right: true, bottom: true, top: true }
        	  })
        	  .on('resizemove', function (event) {
        	    var target = event.target,
        	        x = (parseFloat(target.getAttribute('data-x')) || 0),
        	        y = (parseFloat(target.getAttribute('data-y')) || 0);

        	    // update the element's style
        	    target.style.width  = event.rect.width + 'px';
        	    target.style.height = event.rect.height + 'px';

        	    // translate when resizing from top or left edges
        	    x += event.deltaRect.left;
        	    y += event.deltaRect.top;

        	    target.style.webkitTransform = target.style.transform =
        	        'translate(' + x + 'px,' + y + 'px)';

        	    target.setAttribute('data-x', x);
        	    target.setAttribute('data-y', y);
        	  });*/
    	})
  		}	)
    	
    	/* ------------------------------------------ */
    	/* ----- arrive d'un Artifact dans une ZE ----*/
    	/* ------------------------------------------ */
    	
    	socket.on('EVT_ReceptionArtefactIntoZE',function(pseudo,idZE,chaineJSON)

    	{ 
    		console.log('PAGE : workspace.ejs -> reception evenement [EVT_ReceptionArtefactIntoZE] pour ZE= '+idZE);

 
    		art=JSON.parse(chaineJSON)

    		if (art.typeArtefact == "image") {
           		art.contenu=(art.contenu).replace(/(\r\n|\n|\r)/gm, ""); //supprimer les caract�re sp�ciaux

    	
             	var target = $("<div id="+art.idAr+" class='draggable artefact img dropped-image "+orientationZE[idZE] +"' style='background-image: url(data:image/png;base64,"+art.contenu+")'> </div>");
    		}
    		
    		
    		else {
           		art.contenu=(art.contenu).replace(/(\r\n|\n|\r)/gm, "</br>"); //pour le saut de ligne

	    		  var target = $("<div id="+art.idAr+" class='draggable artefact dropped-msg "+orientationZE[idZE] +"'>  <h1> "+art.titre+" </h1> <p style ='display : none'> "+art.contenu+" </p> </div>")

    		}

   		 target.appendTo("#"+idZE+""); 

    	})
    	
    	/* ------------------------------------------------ */
    	/* ----- arrive d'un Artifact directement en ZP ----*/
    	/* ------------------------------------------------ */

		socket.on('EVT_ReceptionArtefactIntoZP', function (pseudo,idZP,chaineJSON)
		{

    		console.log('PAGE : workspace.ejs -> reception evenement [EVT_ReceptionArtefactIntoZP] pour ZP= '+idZP);

			art=JSON.parse(chaineJSON)

   			if (art.typeArtefact == "image") 
   			{
    			art.contenu=(art.contenu).replace(/(\r\n|\n|\r)/gm, ""); 
    			var target = $("<div id="+art.idAr+" class='draggable artefact img' style='left:50%; top:50%; position: relative; background-image: url(data:image/png;base64,"+art.contenu+")'> </div>");
   			}
   			else {

       			art.contenu=(art.contenu).replace(/(\r\n|\n|\r)/gm, "</br>"); 
	   			var target = $("<div id="+art.idAr+" class='draggable artefact' style='left:50%; top:50% ;position: relative;'>  <h1> "+art.titre+" </h1> <p> "+art.contenu+" </p> </div>");
   			}
		 	target.appendTo("#ZP"); 
		})
 
		/* ------------------------------------------------ */
    	/* ----- suppression d'un artifact d'une ZE ----*/
    	/* ------------------------------------------------ */
		
		socket.on ('EVT_ArtefactDeletedFromZE', function (idAr, idZE, idZEP)
		 {
			console.log('PAGE : workspace.js -> reception evenement [EVT_ArtefactDeletedFromZE] pour IdArt = '+idAr +' idZE=' +idZE+'idZEP='+idZEP);
			$("#"+idZE+"").find("div[id="+idAr+"]").remove();
	
		 })   
		 
		/* ----------------------------- */
    	/* ----- deonnexion d'une ZE ----*/
    	/* ----------------------------- */


		 socket.on('EVT_Deconnexion', function (pseudo, idZE) 
		  {
			$("#"+idZE+"").fadeOut() ; 

			$(function() {
					$("#"+idZE+"").children("div","img").each (function () {
						//myarr[myarr.length]=$(this).attr('id')
						var className =$(this).attr('class');
						var idAr =  $(this).attr('id');
						//$("#"+idZE+"").find("div[id="+idAr+"]");
						var position = $(this).position()
						function getRotationDegrees(obj) { //stocker l'angle de la rotation
							var matrix = obj.css("-webkit-transform") ||
							obj.css("-moz-transform")    ||
							obj.css("-ms-transform")     ||
							obj.css("-o-transform")      ||
							obj.css("transform");
							if(matrix !== 'none') {
							    var values = matrix.split('(')[1].split(')')[0].split(',');
							    var a = values[0];
							    var b = values[1];
							    var angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
							} else { var angle = 0; }
							return angle;
						}
			
						angle1= getRotationDegrees($(this));
			
			
						if (className == "draggable artefact"){ 
							var titre= $(this).find("h1").text();
							var message= $(this).find("p").text();
						
							var target = $("<div id="+idAr+" class='draggable artefact' style='left:"+position.left+"; top:"+position.top+" ;position: absolute; transform: rotate("+angle1+"deg)'>  <h1> "+titre+" </h1> <p> "+message+" </p> </div>");
						}
			
			
						else {

							var bg = $(this).css('background-image'); //l'image
							bg=bg.replace('url(','').replace(')','');
							var target = $("<div id="+idAr+" class='draggable artefact img' style='left:"+position.left+"; top:"+position.top+" position: absolute; transform: rotate("+angle1+"deg)'> </div>").css("background-image", "url("+bg+")");
						}//alert($(this).attr('id'))
						target.appendTo("#ZP"); 		
					});
				});
	

		  })

  
</script>
	    


  
  
  
</html>